<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>文件管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .file-table { margin-top: 20px; }
        .upload-form { background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .category-badge { font-size: 0.75em; }
        .category-stats { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .category-item { padding: 8px 12px; margin: 4px; border-radius: 20px; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; }
        .category-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-decoration: none; }
        .category-item.active { font-weight: bold; border: 2px solid #333; }
        .file-icon { width: 24px; margin-right: 8px; }
        .action-buttons { white-space: nowrap; }

        /* 分类颜色 */
        .category-document { background-color: #2196F3 !important; color: white; }
        .category-image { background-color: #4CAF50 !important; color: white; }
        .category-video { background-color: #FF9800 !important; color: white; }
        .category-audio { background-color: #9C27B0 !important; color: white; }
        .category-archive { background-color: #795548 !important; color: white; }
        .category-other { background-color: #9E9E9E !important; color: white; }
        .category-all { background-color: #6c757d !important; color: white; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4"><i class="fas fa-folder-open"></i> 文件管理系统</h1>

    <!-- 分类统计和筛选 -->
    <div class="category-stats">
        <h5><i class="fas fa-chart-pie"></i> 文件分类</h5>
        <div class="d-flex flex-wrap mt-3">
            <!-- 全部文件链接 -->
            <a th:href="@{/api/file-manager}" class="category-item category-all"
               th:classappend="${currentCategory == null} ? 'active' : ''">
                全部文件
                <span class="badge bg-light text-dark"
                      th:text="${files != null ? #lists.size(files) : 0}"></span>
            </a>
            <!-- 分类筛选链接 -->
            <a th:each="category : ${categories}"
               th:href="@{/api/file-manager(category=${category.name})}"
               class="category-item"
               th:class="'category-' + ${category.name.toLowerCase()} + (${currentCategory == category.name} ? ' active' : '')">
                <span th:text="${category.displayName != null ? category.displayName : category.name}"></span>
                <span class="badge bg-light text-dark"
                      th:text="${categoryStats.get(category) != null ? categoryStats.get(category) : 0}"></span>
            </a>
        </div>
    </div>

    <!-- 上传表单 -->
    <div class="upload-form">
        <h4><i class="fas fa-upload"></i> 上传文件</h4>
        <form th:action="@{/api/upload}" method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="mb-3">
                <label for="fileInput" class="form-label">选择文件</label>
                <input type="file" class="form-control" name="file" id="fileInput" required>
                <div class="form-text">最大支持 2GB 的文件</div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> 上传文件
            </button>
        </form>
    </div>

    <!-- 消息提示 -->
    <div th:if="${message != null and message != ''}" class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fas fa-info-circle"></i>
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- 错误提示 -->
    <div th:if="${error != null and error != ''}" class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        <span th:text="${error}"></span>
    </div>

    <!-- 文件列表 -->
    <div class="file-table">
        <h4>
            <i class="fas fa-list"></i>
            <span th:if="${currentCategory != null}">
                    文件列表 -
                    <span th:each="cat : ${categories}"
                          th:if="${cat.name == currentCategory}"
                          th:text="${cat.displayName != null ? cat.displayName : cat.name}"></span>
                </span>
            <span th:if="${currentCategory == null}">文件列表</span>
        </h4>

        <!-- 使用安全的空值检查 -->
        <div th:if="${files == null or #lists.isEmpty(files)}">
            <p class="text-muted"><i class="fas fa-folder-open"></i> 暂无文件</p>
        </div>

        <!-- 使用安全的非空检查 -->
        <table th:if="${files != null and not #lists.isEmpty(files)}" class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>文件名</th>
                <th>分类</th>
                <th>大小</th>
                <th>类型</th>
                <th>上传时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="file : ${files}">
                <td>
                    <i class="fas fa-file" th:classappend="'text-' + ${@fileIconService != null ? @fileIconService.getCategoryColor(file.category) : 'muted'}"></i>
                    <span th:text="${file.originalFilename}"></span>
                </td>
                <td>
                    <span class="badge category-badge"
                          th:text="${file.category.displayName != null ? file.category.displayName : file.category.name}"
                          th:class="'category-' + ${file.category.name.toLowerCase()}">
                    </span>
                </td>
                <td>
                    <!-- 文件大小格式化 -->
                    <span th:if="${file.size < 1024}" th:text="${file.size} + ' B'"></span>
                    <span th:if="${file.size >= 1024 and file.size < 1048576}"
                          th:text="${#numbers.formatDecimal(file.size/1024, 1, 2)} + ' KB'"></span>
                    <span th:if="${file.size >= 1048576 and file.size < 1073741824}"
                          th:text="${#numbers.formatDecimal(file.size/1048576, 1, 2)} + ' MB'"></span>
                    <span th:if="${file.size >= 1073741824}"
                          th:text="${#numbers.formatDecimal(file.size/1073741824, 1, 2)} + ' GB'"></span>
                </td>
                <td>
                    <span th:text="${file.extension != null ? file.extension : '未知'}"></span>
                </td>
                <td th:text="${#temporals.format(file.uploadTime, 'yyyy-MM-dd HH:mm')}"></td>
                <td class="action-buttons">
                    <!-- 下载链接 -->
                    <a th:href="@{/api/download/{fileName}(fileName=${file.filename})}"
                       class="btn btn-success btn-sm"
                       target="_blank">
                        <i class="fas fa-download"></i> 下载
                    </a>

                    <!-- 删除按钮 -->
                    <form th:action="@{/api/delete/{fileName}(fileName=${file.filename})}"
                          method="post"
                          style="display: inline;"
                          onsubmit="return confirm('确定要删除文件 \'' + [[${file.originalFilename}]] + '\' 吗？此操作无法撤销！');">
                    <button type="submit" class="btn btn-danger btn-sm ms-1">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- API 信息 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-code"></i> REST API 端点</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><strong>上传文件:</strong> POST /api/v1/files/upload</li>
                        <li><strong>批量上传:</strong> POST /api/v1/files/upload/batch</li>
                        <li><strong>获取文件列表:</strong> GET /api/v1/files</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><strong>下载文件:</strong> GET /api/v1/files/download/{filename}</li>
                        <li><strong>删除文件:</strong> DELETE /api/v1/files/{filename}</li>
                        <li><strong>获取文件信息:</strong> GET /api/v1/files/{filename}/info</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 文件大小验证
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('fileInput');
        const maxSize = 2 * 1024 * 1024 * 1024; // 2GB

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file && file.size > maxSize) {
                alert('文件太大！请选择小于 2GB 的文件。');
                this.value = '';
            }
        });
        // 添加上传进度指示
        const uploadForm = document.getElementById('uploadForm');
        uploadForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';
        });
    });

    // 自动关闭警告消息
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                if (alert.classList.contains('show')) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>