name: Build and Release JAR

on:
  push:
    branches: [ main, master ]
  release:
    types: [ published ]

env:
  JAVA_VERSION: '17'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆchangelog

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Get project name and version
        id: project-info
        run: |
          # è·å–é¡¹ç›®åç§°ï¼ˆä½¿ç”¨ä»“åº“åç§°ï¼‰
          PROJECT_NAME="${{ github.event.repository.name }}"
          
          # ä»pom.xmlè·å–ç‰ˆæœ¬å·
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project: $PROJECT_NAME, Version: $VERSION"

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Generate changelog from commits
        id: commit-changelog
        run: |
          # è·å–æœ¬æ¬¡æ„å»ºç›¸å…³çš„æäº¤ä¿¡æ¯
          if [ "${{ github.event_name }}" == "push" ]; then
            # å¯¹äºpushäº‹ä»¶ï¼Œè·å–è¿™æ¬¡pushçš„æäº¤
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              COMMITS=$(git log --oneline --pretty=format:"- %s" ${{ github.event.before }}..${{ github.event.after }} 2>/dev/null || echo "æ— æ³•è·å–ç‰¹å®šèŒƒå›´çš„æäº¤")
            else
              # å¦‚æœæ˜¯åˆå§‹æäº¤æˆ–æ— æ³•è·å–èŒƒå›´ï¼Œä½¿ç”¨æœ€è¿‘10æ¡æäº¤
              COMMITS=$(git log --oneline --pretty=format:"- %s" -10)
            fi
          elif [ "${{ github.event_name }}" == "release" ]; then
            # å¯¹äºreleaseäº‹ä»¶ï¼Œè·å–ä¸Šæ¬¡releaseä»¥æ¥çš„æäº¤
            LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r .tag_name 2>/dev/null || echo "")
            if [ -n "$LATEST_RELEASE" ] && [ "$LATEST_RELEASE" != "null" ]; then
              COMMITS=$(git log --oneline --pretty=format:"- %s" ${LATEST_RELEASE}..HEAD)
            else
              COMMITS=$(git log --oneline --pretty=format:"- %s" -20)
            fi
          else
            COMMITS=$(git log --oneline --pretty=format:"- %s" -10)
          fi
          
          # å¦‚æœæ²¡æœ‰è·å–åˆ°æäº¤æˆ–æäº¤ä¸ºç©º
          if [ -z "$COMMITS" ] || [ "$COMMITS" = "æ— æ³•è·å–ç‰¹å®šèŒƒå›´çš„æäº¤" ]; then
            COMMITS="- ğŸ“ å¸¸è§„æ”¹è¿›å’Œä¼˜åŒ–\n- ğŸ”§ ä»£ç ç»´æŠ¤å’Œé‡æ„"
          fi
          
          # æ ¼å¼åŒ–æäº¤ä¿¡æ¯ï¼Œç§»é™¤é‡å¤çš„ç©ºè¡Œ
          FORMATTED_COMMITS=$(echo -e "$COMMITS" | sed '/^$/N;/^\n$/D')
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—:"
          echo "$FORMATTED_COMMITS"

      - name: Rename JAR file
        run: |
          # é‡å‘½åJARæ–‡ä»¶
          OLD_JAR=$(ls target/*.jar | head -1)
          NEW_JAR="target/${{ steps.project-info.outputs.project_name }}-${{ steps.project-info.outputs.version }}.jar"
          mv "$OLD_JAR" "$NEW_JAR"
          echo "Renamed JAR file: $OLD_JAR -> $NEW_JAR"
          ls -la target/*.jar

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.project-info.outputs.version }}-${{ github.run_number }}
          name: ${{ steps.project-info.outputs.project_name }} v${{ steps.project-info.outputs.version }}
          body: |
            # ğŸš€ ${{ steps.project-info.outputs.project_name }} v${{ steps.project-info.outputs.version }}
            
            ## ğŸ“– æ›´æ–°æ—¥å¿—
            
            ${{ steps.commit-changelog.outputs.CHANGELOG }}
            
            ## ğŸ“Š æ„å»ºä¿¡æ¯
            
            | é¡¹ç›® | ç‰ˆæœ¬ | æ„å»ºæ—¥æœŸ | æ„å»ºç¼–å· | æäº¤å“ˆå¸Œ |
            |------|------|----------|----------|----------|
            | ${{ steps.project-info.outputs.project_name }} | ${{ steps.project-info.outputs.version }} | ${{ steps.date.outputs.date }} | ${{ github.run_number }} | ${{ github.sha }} |
            
            ## ğŸ”§ æŠ€æœ¯è¯¦æƒ…
            - **Javaç‰ˆæœ¬**: ${{ env.JAVA_VERSION }}
            - **æ„å»ºå·¥å…·**: Maven
            - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
            - **åˆ†æ”¯**: ${{ github.ref }}
            
            > æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
          draft: false
          prerelease: false
          files: |
            target/${{ steps.project-info.outputs.project_name }}-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}