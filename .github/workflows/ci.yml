name: Build and Release Spring Boot Application

on:
  # è‡ªåŠ¨è§¦å‘æ¡ä»¶
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/**'
      - 'Dockerfile'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'pom.xml'
  # å‘å¸ƒè§¦å‘
  release:
    types: [ published, created ]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        type: boolean
        default: false
      build_profile:
        description: 'Mavenæ„å»ºprofile'
        required: false
        type: string
        default: ''
      create_release:
        description: 'åˆ›å»ºGitHub Release'
        required: false
        type: boolean
        default: false
      release_type:
        description: 'Releaseç±»å‹'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '--batch-mode --no-transfer-progress'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      src-changed: ${{ steps.changes.outputs.src }}
      config-changed: ${{ steps.changes.outputs.config }}
      any-changed: ${{ steps.changes.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            src:
              - 'src/**'
              - 'pom.xml'
            config:
              - '.github/workflows/**'
              - 'Dockerfile'
              - '**.yml'
              - '**.yaml'

  test:
    needs: check-changes
    if: needs.check-changes.outputs.src-changed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'release'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" = "true" ]; then
            echo "è·³è¿‡æµ‹è¯•"
          else
            mvn clean test ${{ github.event.inputs.build_profile && format(' -P{0}', github.event.inputs.build_profile) || '' }}
          fi

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: failure() && github.event.inputs.skip_tests != 'true'
        with:
          name: test-reports-${{ github.run_number }}
          path: target/surefire-reports/
          retention-days: 30

  build:
    needs: [check-changes, test]
    if: |
      (needs.check-changes.outputs.src-changed == 'true' && needs.test.result == 'success') || 
      (github.event_name == 'workflow_dispatch' && needs.test.result == 'success') ||
      (github.event_name == 'release' && needs.test.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Get version from pom.xml
        id: version
        uses: martinbusko/gitversion-actions@v1

      - name: Build with Maven
        run: |
          PROFILE_OPT=""
          if [ -n "${{ github.event.inputs.build_profile }}" ]; then
            PROFILE_OPT="-P${{ github.event.inputs.build_profile }}"
          fi
          
          mvn clean package -DskipTests $PROFILE_OPT

      - name: Display build info
        run: |
          echo "æ„å»ºç¯å¢ƒ: ${{ github.event.inputs.environment || 'default' }}"
          echo "æ„å»ºProfile: ${{ github.event.inputs.build_profile || 'default' }}"
          echo "è·³è¿‡æµ‹è¯•: ${{ github.event.inputs.skip_tests || 'false' }}"
          echo "åº”ç”¨ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          ls -la target/*.jar

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app-${{ github.run_number }}
          path: target/*.jar
          retention-days: 30

  # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releases
  release:
    needs: build
    if: |
      github.event_name == 'release' || 
      github.ref == 'refs/heads/main' || 
      github.ref == 'refs/heads/master' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-${{ github.run_number }}

      - name: Get version info
        id: version
        run: |
          # ä»pom.xmlè·å–ç‰ˆæœ¬æˆ–ä½¿ç”¨Gitæ ‡ç­¾
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            # ä»pom.xmlè§£æç‰ˆæœ¬
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}-${{ github.run_number }}
          release_name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ github.event.inputs.environment != 'production' }}
          generate_release_notes: true
          files: |
            *.jar
            target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Assets
        if: steps.create_release.outputs.result == 'success'
        run: |
          echo "Release created: ${{ steps.create_release.outputs.url }}"
          echo "Uploaded assets:"
          ls -la *.jar target/*.jar 2>/dev/null || echo "No jar files found"

  # å‘å¸ƒåˆ° Docker Hub æˆ– GitHub Container Registry
  docker-release:
    needs: build
    if: |
      github.event_name == 'release' || 
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Docker Hub Login (å¯é€‰)
        if: env.DOCKERHUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push to Docker Hub (å¯é€‰)
        if: env.DOCKERHUB_USERNAME != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:latest
          cache-from: type=gha

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: [build, release]
    if: |
      github.event_name == 'release' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment != 'development')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-app-${{ github.run_number }}

      - name: Setup deployment
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ° ${{ github.event.inputs.environment || 'production' }} ç¯å¢ƒ"
          echo "éƒ¨ç½²æ–‡ä»¶:"
          ls -la *.jar

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # åœæ­¢å½“å‰è¿è¡Œçš„åº”ç”¨
            sudo systemctl stop my-spring-app || true
            
            # å¤‡ä»½æ—§ç‰ˆæœ¬
            cp /opt/app/my-spring-app.jar /opt/app/backup/my-spring-app-$(date +%Y%m%d%H%M%S).jar || true
            
            # ä¸Šä¼ æ–°ç‰ˆæœ¬ (è¿™ä¸ªæ­¥éª¤éœ€è¦åœ¨ä¹‹å‰çš„æ­¥éª¤ä¸­é€šè¿‡scpä¸Šä¼ )
            # é‡æ–°å¯åŠ¨åº”ç”¨
            sudo systemctl start my-spring-app
            
            # æ£€æŸ¥åº”ç”¨çŠ¶æ€
            sudo systemctl status my-spring-app
        env:
          DEPLOY_ENV: ${{ github.event.inputs.environment || 'production' }}

  # å‘é€é€šçŸ¥
  notify:
    needs: [build, release, deploy]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: failure
          channel: '#ci-cd'
          text: 'æ„å»ºå¤±è´¥: ${{ github.workflow }} #${{ github.run_number }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify success
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: success
          channel: '#ci-cd'
          text: 'æ„å»ºæˆåŠŸ: ${{ github.workflow }} #${{ github.run_number }} - ç‰ˆæœ¬: ${{ needs.build.outputs.version }}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # é…ç½®æ–‡ä»¶å˜æ›´å¤„ç†
  config-update:
    needs: check-changes
    if: needs.check-changes.outputs.config-changed == 'true' && needs.check-changes.outputs.src-changed == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Notify config changes
        run: |
          echo "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€é‡æ–°æ„å»ºåº”ç”¨"

      - name: Create comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ”§ æ£€æµ‹åˆ°å·¥ä½œæµé…ç½®æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€é‡æ–°æ„å»ºåº”ç”¨ã€‚'
            })